name: Validate JSON Schema

on:
  push:
    branches: [ main ]
    paths:
      - 'packages/schema/**/*.json'
      - 'schemas/**/*.json'
      - '.github/workflows/validate-schema.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'packages/schema/**/*.json'
      - 'schemas/**/*.json'
      - '.github/workflows/validate-schema.yml'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Validate schema files are in sync
      run: |
        chmod +x scripts/validate-sync.sh
        npm run validate:sync
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        cache: 'pip'
    
    - name: Install check-jsonschema
      run: pip install check-jsonschema
    
    - name: Validate schema against JSON Schema Draft 7
      run: |
        echo "Validating packages/schema/schemas/v1/retropak.schema.json (source of truth)..."
        check-jsonschema --check-metaschema packages/schema/schemas/v1/retropak.schema.json
    
    - name: Check schema files are valid JSON
      run: |
        for file in schemas/**/*.json; do
          echo "Checking JSON syntax: $file"
          python -m json.tool "$file" > /dev/null
        done
